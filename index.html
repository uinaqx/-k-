<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人生K线 | 3D命运矩阵</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    
    <style>
        /* --- 基础设定 --- */
        :root {
            --bg-color: #050505;
            --gold: #cba051;
            --gold-light: #e6c885;
            --gold-dim: #5c481f;
            --text-main: #e0e0e0;
            --card-glass: rgba(20, 20, 20, 0.85);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: "Songti SC", "Noto Serif SC", serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow: hidden;
            user-select: none;
        }

        #particles-js {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .page {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            display: none;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .page.active {
            display: block;
            opacity: 1;
        }

        /* --- Page 1: 3D 斜向圆环 --- */
        #scene {
            position: relative;
            width: 100%;
            height: 100vh;
            perspective: 2000px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .ring-container {
            position: relative;
            width: 600px;
            height: 600px;
            transform-style: preserve-3d;
            transform: rotateX(70deg) rotateZ(-20deg); 
            animation: rotateRing 40s linear infinite;
        }

        @keyframes rotateRing {
            from { transform: rotateX(70deg) rotateZ(-20deg) rotateY(0deg); }
            to { transform: rotateX(70deg) rotateZ(-20deg) rotateY(360deg); }
        }

        .card-3d {
            position: absolute;
            top: 50%; left: 50%;
            width: 180px;
            height: 260px;
            margin-left: -90px;
            margin-top: -130px;
            background: linear-gradient(135deg, rgba(203,160,81,0.1), rgba(0,0,0,0.9));
            border: 1px solid var(--gold);
            box-shadow: 0 0 15px rgba(203,160,81, 0.2);
            color: var(--gold);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 10px;
            font-size: 0.8rem;
            backface-visibility: visible; 
        }

        .card-title {
            font-size: 1.2rem;
            border-bottom: 1px solid var(--gold-dim);
            margin-bottom: 10px;
            padding-bottom: 5px;
        }

        .center-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            text-align: center;
            pointer-events: none;
        }

        .main-title {
            font-size: 4rem;
            color: var(--gold);
            text-shadow: 0 0 20px rgba(203,160,81,0.6);
            margin: 0;
            letter-spacing: 10px;
        }

        .enter-btn {
            pointer-events: auto;
            margin-top: 40px;
            background: transparent;
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 15px 60px;
            font-size: 1.5rem;
            font-family: serif;
            cursor: pointer;
            transition: 0.4s;
            background: rgba(0,0,0,0.6);
        }

        .enter-btn:hover {
            background: var(--gold);
            color: #000;
            box-shadow: 0 0 30px var(--gold);
        }

        /* --- Page 2: 矩阵输入 --- */
        .input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            /* 修改点：去除纯色背景，使用半透明以便透出粒子 */
            background: rgba(0, 0, 0, 0.55); 
            backdrop-filter: blur(5px);
        }

        .form-box {
            width: 500px;
            padding: 40px;
            border: 1px solid var(--gold-dim);
            background: rgba(20,20,20,0.6); /* 稍微降低不透明度 */
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            text-align: center;
        }

        .input-row {
            margin-bottom: 30px;
            text-align: left;
        }

        .label {
            color: var(--gold);
            font-size: 1rem;
            margin-bottom: 10px;
            display: block;
        }

        .custom-input {
            width: 100%;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border: 1px solid #333;
            color: white;
            font-size: 1.2rem;
            outline: none;
            box-sizing: border-box;
            font-family: serif;
            text-align: center;
        }

        .gender-options {
            display: flex;
            gap: 20px;
        }
        .gender-btn {
            flex: 1;
            padding: 15px;
            border: 1px solid #444;
            color: #666;
            cursor: pointer;
            transition: 0.3s;
            text-align: center;
        }
        .gender-btn.selected {
            border-color: var(--gold);
            color: var(--gold);
            background: rgba(203,160,81,0.1);
        }

        .date-display {
            display: flex;
            gap: 10px;
        }
        .date-box {
            flex: 1;
            height: 50px;
            border: 1px solid var(--gold-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: 0.3s;
            color: #888;
        }
        .date-box:hover, .date-box.active {
            border-color: var(--gold);
            color: var(--gold);
        }
        .date-box.filled {
            color: #fff;
        }

        /* 弹窗通用样式 */
        .overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        /* 数字选择弹窗 */
        .grid-panel {
            width: 600px;
            max-width: 90%;
            background: #111;
            border: 1px solid var(--gold);
            padding: 20px;
        }
        .grid-header {
            text-align: center;
            color: var(--gold);
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        .grid-content {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            max-height: 50vh;
            overflow-y: auto;
        }
        .grid-num {
            padding: 15px;
            background: #222;
            text-align: center;
            cursor: pointer;
            border: 1px solid #333;
        }
        .grid-num:hover {
            border-color: var(--gold);
            background: #333;
        }
        .grid-content::-webkit-scrollbar { width: 5px; }
        .grid-content::-webkit-scrollbar-thumb { background: var(--gold-dim); }

        /* 评价弹窗样式 */
        .eval-box {
            width: 500px;
            padding: 40px;
            background: #000;
            border: 2px solid var(--gold);
            text-align: center;
            position: relative;
        }
        .eval-title {
            color: var(--gold);
            font-size: 1.5rem;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .eval-text-group {
            text-align: left;
            margin: 20px 0;
            line-height: 1.8;
            font-size: 1.1rem;
        }
        .eval-label {
            color: var(--gold-light);
            font-weight: bold;
        }
        .eval-content {
            color: #ccc;
        }

        /* --- Page 3: 结果 --- */
        .chart-wrapper {
            width: 100%;
            height: 100%;
            padding: 40px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }

        /* --- Loading Page --- */
        .loading-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 30px;
            text-align: center;
            background: radial-gradient(circle at center, rgba(203,160,81,0.1), rgba(0,0,0,0.9));
        }

        .loading-title {
            font-size: 2.4rem;
            color: var(--gold);
            letter-spacing: 6px;
        }

        .loading-subtitle {
            color: #777;
            letter-spacing: 4px;
            font-size: 0.9rem;
        }

        .loading-evidence {
            width: 60%;
            max-width: 720px;
            min-height: 140px;
            border: 1px solid rgba(203,160,81,0.3);
            background: rgba(0,0,0,0.6);
            padding: 20px;
            box-shadow: 0 0 20px rgba(203,160,81,0.15);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .loading-evidence-item {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.6s ease, transform 0.6s ease;
            color: #cfcfcf;
            font-size: 1rem;
        }

        .loading-evidence-item.active {
            opacity: 1;
            transform: translateY(0);
            color: var(--gold-light);
        }

        .trend-preview {
            width: 60%;
            max-width: 720px;
            border: 1px solid rgba(203,160,81,0.2);
            padding: 18px 24px;
            background: rgba(15,15,15,0.7);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .trend-line {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            height: 80px;
        }

        .trend-segment {
            flex: 1;
            background: linear-gradient(180deg, rgba(203,160,81,0.85), rgba(203,160,81,0.15));
            border-radius: 6px 6px 0 0;
            transition: height 0.6s ease;
        }

        .trend-labels {
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <div id="particles-js"></div>

    <div id="page1" class="page active">
        <div id="scene">
            <div class="ring-container" id="ring"></div>
            <div class="center-overlay">
                <h1 class="main-title">人生K线</h1>
                <p style="letter-spacing: 5px; color: #888; font-size: 0.8rem; margin-bottom: 30px;">THE ALGORITHM OF DESTINY</p>
                <button class="enter-btn" onclick="goToPage(2)">洞悉天机</button>
            </div>
        </div>
    </div>

    <div id="page2" class="page">
        <div class="input-container">
            <div class="form-box">
                <h2 style="color:var(--gold); margin-bottom:40px; font-weight:lighter;">录入命盘信息</h2>
                
                <div class="input-row">
                    <label class="label">姓名 / NAME</label>
                    <input type="text" id="nameInput" class="custom-input" placeholder="请输入您的姓名" autocomplete="off">
                </div>

                <div class="input-row">
                    <label class="label">性别 / GENDER</label>
                    <div class="gender-options">
                        <div class="gender-btn" onclick="selectGender(this, '乾造 (男)')">乾造 (男)</div>
                        <div class="gender-btn" onclick="selectGender(this, '坤造 (女)')">坤造 (女)</div>
                    </div>
                </div>

                <div class="input-row">
                    <label class="label">生辰 / BIRTH DATE</label>
                    <div class="date-display">
                        <div class="date-box" id="yearBox" onclick="openGrid('year')">年份</div>
                        <div class="date-box" id="monthBox" onclick="openGrid('month')">月份</div>
                        <div class="date-box" id="dayBox" onclick="openGrid('day')">日期</div>
                    </div>
                </div>

                <button class="enter-btn" style="width:100%; padding: 12px; margin-top:20px;" onclick="generateChart()">开始推演</button>
                <div style="margin-top:15px; cursor:pointer; font-size:0.8rem; color:#666;" onclick="goToPage(1)">返回首页</div>
            </div>
        </div>
    </div>

    <div id="page3" class="page">
        <div class="loading-container">
            <div>
                <div class="loading-title">推演中</div>
                <div class="loading-subtitle">DESTINY LOADING</div>
            </div>
            <div class="loading-evidence" id="loadingEvidence"></div>
            <div class="trend-preview">
                <div style="color: var(--gold); font-size: 0.95rem; letter-spacing: 2px;">即将生成的K线趋势预判</div>
                <div class="trend-line">
                    <div class="trend-segment" style="height: 35%;"></div>
                    <div class="trend-segment" style="height: 55%;"></div>
                    <div class="trend-segment" style="height: 90%;"></div>
                    <div class="trend-segment" style="height: 70%;"></div>
                    <div class="trend-segment" style="height: 62%;"></div>
                </div>
                <div class="trend-labels">
                    <span>少年积势</span>
                    <span>青年攀升</span>
                    <span>中年峰值</span>
                    <span>50后回落</span>
                    <span>晚年平稳</span>
                </div>
            </div>
            <div style="color:#555; font-size:0.85rem;">资料校验完成后将自动呈现完整K线</div>
        </div>
    </div>

    <div id="page4" class="page">
        <div class="chart-wrapper">
            <div class="chart-header">
                <div>
                    <h1 id="resName" style="color: var(--gold); margin: 0; font-size: 2rem;"></h1>
                    <span id="resInfo" style="color: #666; font-size: 0.9rem;"></span>
                </div>
                <div style="text-align: right; display: flex; gap: 15px;">
                    <button class="enter-btn" style="padding: 8px 20px; font-size: 1rem;" onclick="showEvaluation()">天机批注</button>
                    <button class="enter-btn" style="padding: 8px 20px; font-size: 1rem;" onclick="location.reload()">重置</button>
                </div>
            </div>
            <div id="kline" style="flex: 1; width: 100%;"></div>
        </div>
    </div>

    <div class="overlay" id="gridOverlay" onclick="closeGrid(event)">
        <div class="grid-panel" onclick="event.stopPropagation()">
            <div class="grid-header" id="gridTitle">请选择</div>
            <div class="grid-content" id="gridContent"></div>
        </div>
    </div>

    <div class="overlay" id="evalOverlay" onclick="closeEval(event)">
        <div class="eval-box" onclick="event.stopPropagation()">
            <div class="eval-title">命运判词</div>
            <div class="eval-text-group">
                <span class="eval-label">综合评价：</span>
                <span id="evalSummary" class="eval-content"></span>
            </div>
            <div class="eval-text-group">
                <span class="eval-label">K线解析：</span>
                <span id="evalDetail" class="eval-content"></span>
            </div>
            <button class="enter-btn" style="margin-top:20px; padding:10px 40px; font-size:1rem;" onclick="closeEval(null)">退下</button>
        </div>
    </div>

    <script>
        /* --- 修改点：增强粒子特效 --- */
        particlesJS("particles-js", {
            particles: {
                number: { value: 80 }, /* 增加粒子数量 */
                color: { value: "#cba051" },
                shape: { type: "circle" },
                opacity: { value: 0.5, random: true },
                size: { value: 3, random: true }, /* 随机大小 */
                line_linked: { 
                    enable: true, 
                    distance: 150, 
                    color: "#cba051", 
                    opacity: 0.3, /* 增加连线可见度 */
                    width: 1 
                },
                move: { speed: 1 }
            },
            interactivity: {
                detect_on: "canvas",
                events: {
                    onhover: { enable: true, mode: "grab" },
                    onclick: { enable: true, mode: "push" }
                }
            }
        });

        /* --- Page 1: 生成3D圆环卡片 --- */
        const ring = document.getElementById('ring');
        const dataPoints = [
            "紫微斗数模型", "纳音五行算法", "易经六十四卦", 
            "大运流年推导", "真太阳时校正", "量化金融模型",
            "生命周期理论", "玄空飞星排盘", "天干地支刑冲", "贝叶斯概率修正"
        ];

        dataPoints.forEach((text, index) => {
            const card = document.createElement('div');
            card.className = 'card-3d';
            const angle = index * 36;
            card.style.transform = `rotateY(${angle}deg) translateZ(400px)`;
            card.innerHTML = `
                <div class="card-title">SOURCE ${index + 1}</div>
                <div style="font-size:1.4rem; font-weight:bold;">${text}</div>
                <div style="margin-top:auto; font-size:0.6rem; opacity:0.6;">VERIFIED DATA</div>
            `;
            ring.appendChild(card);
        });

        /* --- Page Switch Logic --- */
        function goToPage(n) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page${n}`).classList.add('active');
        }

        /* --- Page 2 Logic --- */
        let selectedData = { gender: '', year: null, month: null, day: null };
        let currentPicking = '';

        function selectGender(el, val) {
            document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            selectedData.gender = val;
        }

        function openGrid(type) {
            currentPicking = type;
            const overlay = document.getElementById('gridOverlay');
            const content = document.getElementById('gridContent');
            const title = document.getElementById('gridTitle');
            content.innerHTML = '';
            overlay.style.display = 'flex';

            let start, end;
            if (type === 'year') {
                title.innerText = "请选择出生年份";
                start = 1960; end = 2025;
            } else if (type === 'month') {
                title.innerText = "请选择出生月份";
                start = 1; end = 12;
            } else {
                title.innerText = "请选择出生日期";
                start = 1; end = 31;
            }

            for (let i = start; i <= end; i++) {
                const num = document.createElement('div');
                num.className = 'grid-num';
                num.innerText = i;
                num.onclick = () => pickNumber(i);
                content.appendChild(num);
            }
        }

        function pickNumber(num) {
            selectedData[currentPicking] = num;
            const box = document.getElementById(`${currentPicking}Box`);
            box.innerText = num + (currentPicking === 'year' ? '年' : (currentPicking === 'month' ? '月' : '日'));
            box.classList.add('filled');
            document.getElementById('gridOverlay').style.display = 'none';
        }

        function closeGrid(e) {
            if (e.target.id === 'gridOverlay') {
                e.target.style.display = 'none';
            }
        }

        /* --- Page 3 & Chart Logic --- */
        let globalChartData = null; // 存储当前生成的数据用于评价

        let loadingTimer = null;
        let loadingInterval = null;

        function generateChart() {
            const name = document.getElementById('nameInput').value;
            if (!name || !selectedData.year || !selectedData.month || !selectedData.day || !selectedData.gender) {
                alert("请完整填写命盘信息，方可推演。");
                return;
            }

            document.getElementById('resName').innerText = name;
            document.getElementById('resInfo').innerText = `${selectedData.gender} | ${selectedData.year}年${selectedData.month}月${selectedData.day}日生 | 命主元神`;

            startLoadingSequence();
        }

        function startLoadingSequence() {
            const evidenceItems = [
                "调取紫微斗数主星排布",
                "校正真太阳时与天干地支",
                "检索量化金融波动模型",
                "比对生命周期理论曲线",
                "合并大运流年与飞星走势",
                "推演中年峰值与晚年平衡"
            ];

            const evidenceContainer = document.getElementById('loadingEvidence');
            evidenceContainer.innerHTML = '';
            evidenceItems.forEach((text) => {
                const item = document.createElement('div');
                item.className = 'loading-evidence-item';
                item.innerText = text;
                evidenceContainer.appendChild(item);
            });

            goToPage(3);

            let index = 0;
            if (loadingInterval) clearInterval(loadingInterval);
            loadingInterval = setInterval(() => {
                const items = evidenceContainer.querySelectorAll('.loading-evidence-item');
                if (index < items.length) {
                    items[index].classList.add('active');
                    index += 1;
                } else {
                    clearInterval(loadingInterval);
                }
            }, 700);

            if (loadingTimer) clearTimeout(loadingTimer);
            loadingTimer = setTimeout(() => {
                goToPage(4);
                initKlineChart();
            }, 5000);
        }

        function initKlineChart() {
            const chartDom = document.getElementById('kline');
            const myChart = echarts.init(chartDom);
            
            const data = generateRealisticData();
            globalChartData = data; // 保存数据用于评价

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'line', lineStyle: { color: '#cba051', type: 'dashed' } },
                    backgroundColor: 'rgba(20,20,20,0.95)',
                    borderColor: '#cba051',
                    textStyle: { color: '#fff', fontSize: 14 },
                    /* 修改点：Tooltip 仅显示当前年龄 */
                    formatter: function (params) {
                        // params[0] 是第一个系列的数据，name 是 x轴的值（年龄）
                        return `<div style="padding:5px 10px; font-weight:bold; color:#cba051;">当前年龄：${params[0].name}</div>`;
                    }
                },
                grid: { left: '5%', right: '5%', top: '10%', bottom: '10%' },
                xAxis: {
                    type: 'category',
                    data: data.years,
                    axisLine: { lineStyle: { color: '#444' } },
                    axisLabel: { color: '#666' }
                },
                yAxis: {
                    scale: true,
                    splitLine: { lineStyle: { color: '#222' } },
                    axisLabel: { show: false }
                },
                series: [
                    {
                        name: '运势',
                        type: 'candlestick',
                        data: data.values,
                        itemStyle: {
                            color: '#cba051',
                            color0: '#5470c6',
                            borderColor: '#cba051',
                            borderColor0: '#5470c6'
                        },
                        markPoint: {
                            data: data.annotations,
                            symbol: 'pin',
                            symbolSize: 45,
                            itemStyle: { color: '#fff' },
                            label: { color: '#000', fontWeight: 'bold', fontSize: 10 }
                        }
                    },
                    {
                        name: '趋势',
                        type: 'line',
                        data: calculateMA(10, data.values),
                        smooth: true,
                        lineStyle: { opacity: 0.5, color: '#fff', width: 1 },
                        symbol: 'none'
                    }
                ]
            };

            option.graphic = data.texts.map(t => ({
                type: 'text',
                left: t.x,
                top: t.y,
                style: {
                    text: t.text,
                    fill: '#cba051',
                    font: '14px "Songti SC"'
                }
            }));

            myChart.setOption(option);
            window.addEventListener('resize', () => myChart.resize());
        }

        /* --- 评价逻辑 --- */
        function showEvaluation() {
            if (!globalChartData) return;
            generateAnalysis(globalChartData);
            document.getElementById('evalOverlay').style.display = 'flex';
        }

        function closeEval(e) {
            if (!e || e.target.id === 'evalOverlay') {
                document.getElementById('evalOverlay').style.display = 'none';
            }
        }

        function generateAnalysis(data) {
            // 解析数据
            // values数组元素: [open, close, low, high]
            const values = data.values;
            let maxRise = -Infinity;
            let maxRiseAge = 0;
            let maxFall = Infinity;
            let maxFallAge = 0;
            let startPrice = parseFloat(values[0][0]);
            let endPrice = parseFloat(values[values.length - 1][1]);
            let maxPrice = -Infinity;
            let maxPriceAge = 0;
            let minPrice = Infinity;
            let minPriceAge = 0;
            let sumVolatility = 0;

            // 寻找关键节点
            for (let i = 0; i < values.length; i++) {
                let open = parseFloat(values[i][0]);
                let close = parseFloat(values[i][1]);
                let high = parseFloat(values[i][3]);
                let low = parseFloat(values[i][2]);
                let change = close - open;

                sumVolatility += Math.abs(change);
                if (change > maxRise) { maxRise = change; maxRiseAge = i; }
                if (change < maxFall) { maxFall = change; maxFallAge = i; }
                if (high > maxPrice) { maxPrice = high; maxPriceAge = i; }
                if (low < minPrice) { minPrice = low; minPriceAge = i; }
            }

            const totalChange = endPrice - startPrice;
            const avgVolatility = sumVolatility / values.length;
            const earlyPrice = parseFloat(values[30][1] || values[values.length - 1][1]);
            const midPrice = parseFloat(values[60][1] || values[values.length - 1][1]);
            const latePrice = parseFloat(values[80][1] || values[values.length - 1][1]);

            const context = {
                totalChange,
                avgVolatility,
                maxRise,
                maxFall,
                maxRiseAge,
                maxFallAge,
                maxPriceAge,
                minPriceAge,
                startPrice,
                endPrice,
                earlyPrice,
                midPrice,
                latePrice
            };

            const profiles = [
                {
                    summary: "大起大落",
                    match: ctx => ctx.maxRise > 9 && ctx.maxFall < -9 && ctx.avgVolatility > 4,
                    detail: ctx => `运势峰谷分明，${ctx.maxRiseAge}岁迎来冲天之势，${ctx.maxFallAge}岁亦有波折。起落之间见真章，能在震荡中磨砺心性。`
                },
                {
                    summary: "一路高歌",
                    match: ctx => ctx.totalChange > 25 && ctx.maxFall > -6,
                    detail: ctx => `整体走势昂扬，${ctx.maxRiseAge}岁出现关键跃升，后续波折不大，属于顺势而上的好运之局。`
                },
                {
                    summary: "高开低走",
                    match: ctx => ctx.maxPriceAge < 35 && ctx.totalChange < -12,
                    detail: ctx => `早年锋芒毕露，却在中后期走弱。${ctx.maxPriceAge}岁巅峰之后需懂得守势，方能以静制动。`
                },
                {
                    summary: "先抑后扬",
                    match: ctx => ctx.minPriceAge < 40 && ctx.totalChange > 10,
                    detail: ctx => `前期阻滞难免，${ctx.minPriceAge}岁触底蓄势，后续逐步回升，厚积而终能扬眉。`
                },
                {
                    summary: "峰回路转",
                    match: ctx => ctx.maxFall < -8 && ctx.endPrice > ctx.startPrice && ctx.maxRiseAge > ctx.maxFallAge,
                    detail: ctx => `低谷之后转机陡现，${ctx.maxFallAge}岁考验最甚，${ctx.maxRiseAge}岁迎来转折，逆势扭转乾坤。`
                },
                {
                    summary: "逆风翻盘",
                    match: ctx => ctx.maxFall < -10 && ctx.totalChange > 5,
                    detail: ctx => `遭遇强风仍能翻盘，${ctx.maxFallAge}岁受挫但不失志，后续逐渐修复并取得领先。`
                },
                {
                    summary: "厚积薄发",
                    match: ctx => ctx.maxRiseAge > 60 && ctx.totalChange > 12,
                    detail: ctx => `前半生积蓄能量，${ctx.maxRiseAge}岁后迎来爆发，后劲绵长，晚景可期。`
                },
                {
                    summary: "晚来福厚",
                    match: ctx => ctx.maxPriceAge > 75 && ctx.endPrice > ctx.midPrice,
                    detail: ctx => `福泽在晚年聚拢，${ctx.maxPriceAge}岁运势登顶，属于后发而厚的稳福格局。`
                },
                {
                    summary: "守成有道",
                    match: ctx => Math.abs(ctx.totalChange) < 8 && ctx.avgVolatility < 3.5,
                    detail: ctx => `走势平稳，起伏不大。守得住节奏便可安然前行，适合以稳为主，累积福气。`
                },
                {
                    summary: "稳中求进",
                    match: () => true,
                    detail: ctx => `整体温和向前，${ctx.maxRiseAge}岁有阶段性提升，稳健中寻求增长，宜步步为营。`
                }
            ];

            const profile = profiles.find(item => item.match(context));

            document.getElementById('evalSummary').innerText = `“${profile.summary}”`;
            document.getElementById('evalDetail').innerText = `“${profile.detail(context)}”`;
        }

        function generateRealisticData() {
            let years = [];
            let values = [];
            let annotations = [];
            let texts = [];
            let price = 52;
            let changes = [];
            let highs = [];
            let lows = [];

            const segments = [
                { start: 0, end: 18, drift: -0.2, volatility: 2.6, eventBoost: -2.5 },
                { start: 19, end: 35, drift: 0.9, volatility: 3.1, eventBoost: 3.8 },
                { start: 36, end: 50, drift: 0.25, volatility: 2.3, eventBoost: 1.2 },
                { start: 51, end: 60, drift: -0.15, volatility: 1.4, eventBoost: -0.4 },
                { start: 61, end: 75, drift: 0.1, volatility: 1.6, eventBoost: 0.8 },
                { start: 76, end: 100, drift: -0.05, volatility: 1.4, eventBoost: 0.5 }
            ];

            let segmentIndex = 0;

            for (let i = 0; i <= 100; i++) {
                years.push(i + "岁");

                if (i > segments[segmentIndex].end && segmentIndex < segments.length - 1) {
                    segmentIndex += 1;
                }

                const segment = segments[segmentIndex];
                let change = segment.drift + (Math.random() - 0.5) * segment.volatility;

                if (i === segment.start + Math.floor((segment.end - segment.start) / 2)) {
                    change += segment.eventBoost;
                }

                if (i === 28) change += 2.5;
                if (i === 42) change -= 2.8;
                if (i === 66) change += 1.4;

                if (i >= 50 && i <= 60) {
                    change = Math.min(change, 0.35) - 0.2;
                }

                let open = price;
                let close = price + change;
                let low = Math.min(open, close) - (Math.random() * segment.volatility * 0.8 + 0.8);
                let high = Math.max(open, close) + (Math.random() * segment.volatility * 0.8 + 0.8);

                if (low < 10) { low = 10; close = 12; open = 11; }

                values.push([open.toFixed(1), close.toFixed(1), low.toFixed(1), high.toFixed(1)]);
                changes.push(change);
                highs.push(high);
                lows.push(low);

                price = close;
            }

            const peakRange = { start: 28, end: 50 };
            const peakHigh = Math.max(...highs.slice(peakRange.start, peakRange.end + 1));
            const peakHighIndex = highs.indexOf(peakHigh);

            highs.forEach((value, idx) => {
                if (idx < peakRange.start || idx > peakRange.end) {
                    if (value >= peakHigh) {
                        highs[idx] = peakHigh - (0.5 + Math.random() * 1.5);
                        const adjustedHigh = highs[idx];
                        const row = values[idx].map(Number);
                        row[3] = adjustedHigh.toFixed(1);
                        if (row[1] > adjustedHigh) row[1] = (adjustedHigh - 0.3).toFixed(1);
                        values[idx] = row.map(num => Number(num).toFixed(1));
                    }
                }
            });

            const maxRise = Math.max(...changes);
            const maxFall = Math.min(...changes);
            const maxRiseIndex = changes.indexOf(maxRise);
            const maxFallIndex = changes.indexOf(maxFall);
            const maxHighIndex = peakHighIndex;
            const minLowIndex = lows.indexOf(Math.min(...lows));

            const usedIndexes = new Set();
            const addAnnotation = (index, label, value, color) => {
                if (usedIndexes.has(index)) return;
                usedIndexes.add(index);
                const coordValue = label === '回撤' || label === '探底' ? lows[index] : highs[index];
                const annotation = {
                    name: label,
                    coord: [index, coordValue],
                    value: value
                };
                if (color) {
                    annotation.itemStyle = { color };
                }
                annotations.push(annotation);
            };

            addAnnotation(maxRiseIndex, '破局', '跃升', '#f7d37a');
            addAnnotation(maxFallIndex, '回撤', '警示', '#5470c6');
            addAnnotation(maxHighIndex, '登顶', '巅峰', '#f0c46b');
            addAnnotation(minLowIndex, '探底', '蓄势', '#3a5aa0');

            if (annotations.length < 2) {
                addAnnotation(30, '转机', '变势', '#f0c46b');
                addAnnotation(70, '蜕变', '突破', '#f0c46b');
            }

            annotations.slice(0, 3).forEach((item) => {
                const index = item.coord[0];
                const y = ['回撤', '探底'].includes(item.name) ? '78%' : '18%';
                texts.push({ text: `${index}岁：${item.name}`, x: `${index}%`, y });
            });

            return { years, values, annotations, texts };
        }

        function calculateMA(dayCount, data) {
            var result = [];
            for (var i = 0, len = data.length; i < len; i++) {
                if (i < dayCount) { result.push('-'); continue; }
                var sum = 0;
                for (var j = 0; j < dayCount; j++) { sum += parseFloat(data[i - j][1]); }
                result.push((sum / dayCount).toFixed(1));
            }
            return result;
        }
    </script>
</body>
</html>
