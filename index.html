<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人生K线 | 3D命运矩阵</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    
    <style>
        /* --- 基础设定 --- */
        :root {
            --bg-color: #050505;
            --gold: #cba051;
            --gold-light: #e6c885;
            --gold-dim: #5c481f;
            --text-main: #e0e0e0;
            --card-glass: rgba(20, 20, 20, 0.85);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: "Songti SC", "Noto Serif SC", serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow: hidden;
            user-select: none;
        }

        #particles-js {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .page {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            display: none;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .page.active {
            display: block;
            opacity: 1;
        }

        /* --- Page 1: 3D 斜向圆环 --- */
        #scene {
            position: relative;
            width: 100%;
            height: 100vh;
            perspective: 2000px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .ring-container {
            position: relative;
            width: 600px;
            height: 600px;
            transform-style: preserve-3d;
            transform: rotateX(70deg) rotateZ(-20deg); 
            animation: rotateRing 40s linear infinite;
        }

        @keyframes rotateRing {
            from { transform: rotateX(70deg) rotateZ(-20deg) rotateY(0deg); }
            to { transform: rotateX(70deg) rotateZ(-20deg) rotateY(360deg); }
        }

        .card-3d {
            position: absolute;
            top: 50%; left: 50%;
            width: 180px;
            height: 260px;
            margin-left: -90px;
            margin-top: -130px;
            background: linear-gradient(135deg, rgba(203,160,81,0.1), rgba(0,0,0,0.9));
            border: 1px solid var(--gold);
            box-shadow: 0 0 15px rgba(203,160,81, 0.2);
            color: var(--gold);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 10px;
            font-size: 0.8rem;
            backface-visibility: visible; 
        }

        .card-title {
            font-size: 1.2rem;
            border-bottom: 1px solid var(--gold-dim);
            margin-bottom: 10px;
            padding-bottom: 5px;
        }

        .center-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            text-align: center;
            pointer-events: none;
        }

        .main-title {
            font-size: 4rem;
            color: var(--gold);
            text-shadow: 0 0 20px rgba(203,160,81,0.6);
            margin: 0;
            letter-spacing: 10px;
        }

        .enter-btn {
            pointer-events: auto;
            margin-top: 40px;
            background: transparent;
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 15px 60px;
            font-size: 1.5rem;
            font-family: serif;
            cursor: pointer;
            transition: 0.4s;
            background: rgba(0,0,0,0.6);
        }

        .enter-btn:hover {
            background: var(--gold);
            color: #000;
            box-shadow: 0 0 30px var(--gold);
        }

        /* --- Page 2: 矩阵输入 --- */
        .input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            /* 修改点：去除纯色背景，使用半透明以便透出粒子 */
            background: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(5px);
        }

        .form-box {
            width: 500px;
            padding: 40px;
            border: 1px solid var(--gold-dim);
            background: rgba(20,20,20,0.6); /* 稍微降低不透明度 */
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            text-align: center;
        }

        .input-row {
            margin-bottom: 30px;
            text-align: left;
        }

        .label {
            color: var(--gold);
            font-size: 1rem;
            margin-bottom: 10px;
            display: block;
        }

        .custom-input {
            width: 100%;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border: 1px solid #333;
            color: white;
            font-size: 1.2rem;
            outline: none;
            box-sizing: border-box;
            font-family: serif;
            text-align: center;
        }

        .gender-options {
            display: flex;
            gap: 20px;
        }
        .gender-btn {
            flex: 1;
            padding: 15px;
            border: 1px solid #444;
            color: #666;
            cursor: pointer;
            transition: 0.3s;
            text-align: center;
        }
        .gender-btn.selected {
            border-color: var(--gold);
            color: var(--gold);
            background: rgba(203,160,81,0.1);
        }

        .date-display {
            display: flex;
            gap: 10px;
        }
        .date-box {
            flex: 1;
            height: 50px;
            border: 1px solid var(--gold-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: 0.3s;
            color: #888;
        }
        .date-box:hover, .date-box.active {
            border-color: var(--gold);
            color: var(--gold);
        }
        .date-box.filled {
            color: #fff;
        }

        /* 弹窗通用样式 */
        .overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        /* 数字选择弹窗 */
        .grid-panel {
            width: 600px;
            max-width: 90%;
            background: #111;
            border: 1px solid var(--gold);
            padding: 20px;
        }
        .grid-header {
            text-align: center;
            color: var(--gold);
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        .grid-content {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            max-height: 50vh;
            overflow-y: auto;
        }
        .grid-num {
            padding: 15px;
            background: #222;
            text-align: center;
            cursor: pointer;
            border: 1px solid #333;
        }
        .grid-num:hover {
            border-color: var(--gold);
            background: #333;
        }
        .grid-content::-webkit-scrollbar { width: 5px; }
        .grid-content::-webkit-scrollbar-thumb { background: var(--gold-dim); }

        /* 评价弹窗样式 */
        .eval-box {
            width: 500px;
            padding: 40px;
            background: #000;
            border: 2px solid var(--gold);
            box-shadow: 0 0 50px rgba(203, 160, 81, 0.3);
            text-align: center;
            position: relative;
        }
        .eval-title {
            color: var(--gold);
            font-size: 1.5rem;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .eval-text-group {
            text-align: left;
            margin: 20px 0;
            line-height: 1.8;
            font-size: 1.1rem;
        }
        .eval-label {
            color: var(--gold-light);
            font-weight: bold;
        }
        .eval-content {
            color: #ccc;
        }

        /* --- Page 3: 结果 --- */
        .chart-wrapper {
            width: 100%;
            height: 100%;
            padding: 40px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
    </style>
</head>
<body>

    <div id="particles-js"></div>

    <div id="page1" class="page active">
        <div id="scene">
            <div class="ring-container" id="ring"></div>
            <div class="center-overlay">
                <h1 class="main-title">人生K线</h1>
                <p style="letter-spacing: 5px; color: #888; font-size: 0.8rem; margin-bottom: 30px;">THE ALGORITHM OF DESTINY</p>
                <button class="enter-btn" onclick="goToPage(2)">洞悉天机</button>
            </div>
        </div>
    </div>

    <div id="page2" class="page">
        <div class="input-container">
            <div class="form-box">
                <h2 style="color:var(--gold); margin-bottom:40px; font-weight:lighter;">录入命盘信息</h2>
                
                <div class="input-row">
                    <label class="label">姓名 / NAME</label>
                    <input type="text" id="nameInput" class="custom-input" placeholder="请输入您的姓名" autocomplete="off">
                </div>

                <div class="input-row">
                    <label class="label">性别 / GENDER</label>
                    <div class="gender-options">
                        <div class="gender-btn" onclick="selectGender(this, '乾造 (男)')">乾造 (男)</div>
                        <div class="gender-btn" onclick="selectGender(this, '坤造 (女)')">坤造 (女)</div>
                    </div>
                </div>

                <div class="input-row">
                    <label class="label">生辰 / BIRTH DATE</label>
                    <div class="date-display">
                        <div class="date-box" id="yearBox" onclick="openGrid('year')">年份</div>
                        <div class="date-box" id="monthBox" onclick="openGrid('month')">月份</div>
                        <div class="date-box" id="dayBox" onclick="openGrid('day')">日期</div>
                    </div>
                </div>

                <button class="enter-btn" style="width:100%; padding: 12px; margin-top:20px;" onclick="generateChart()">开始推演</button>
                <div style="margin-top:15px; cursor:pointer; font-size:0.8rem; color:#666;" onclick="goToPage(1)">返回首页</div>
            </div>
        </div>
    </div>

    <div id="page3" class="page">
        <div class="chart-wrapper">
            <div class="chart-header">
                <div>
                    <h1 id="resName" style="color: var(--gold); margin: 0; font-size: 2rem;"></h1>
                    <span id="resInfo" style="color: #666; font-size: 0.9rem;"></span>
                </div>
                <div style="text-align: right; display: flex; gap: 15px;">
                    <button class="enter-btn" style="padding: 8px 20px; font-size: 1rem;" onclick="showEvaluation()">天机批注</button>
                    <button class="enter-btn" style="padding: 8px 20px; font-size: 1rem;" onclick="location.reload()">重置</button>
                </div>
            </div>
            <div id="kline" style="flex: 1; width: 100%;"></div>
        </div>
    </div>

    <div class="overlay" id="gridOverlay" onclick="closeGrid(event)">
        <div class="grid-panel" onclick="event.stopPropagation()">
            <div class="grid-header" id="gridTitle">请选择</div>
            <div class="grid-content" id="gridContent"></div>
        </div>
    </div>

    <div class="overlay" id="evalOverlay" onclick="closeEval(event)">
        <div class="eval-box" onclick="event.stopPropagation()">
            <div class="eval-title">命运判词</div>
            <div class="eval-text-group">
                <span class="eval-label">综合评价：</span>
                <span id="evalSummary" class="eval-content"></span>
            </div>
            <div class="eval-text-group">
                <span class="eval-label">K线解析：</span>
                <span id="evalDetail" class="eval-content"></span>
            </div>
            <button class="enter-btn" style="margin-top:20px; padding:10px 40px; font-size:1rem;" onclick="closeEval(null)">退下</button>
        </div>
    </div>

    <script>
        /* --- 修改点：增强粒子特效 --- */
        particlesJS("particles-js", {
            particles: {
                number: { value: 80 }, /* 增加粒子数量 */
                color: { value: "#cba051" },
                shape: { type: "circle" },
                opacity: { value: 0.5, random: true },
                size: { value: 3, random: true }, /* 随机大小 */
                line_linked: { 
                    enable: true, 
                    distance: 150, 
                    color: "#cba051", 
                    opacity: 0.3, /* 增加连线可见度 */
                    width: 1 
                },
                move: { speed: 1 }
            },
            interactivity: {
                detect_on: "canvas",
                events: {
                    onhover: { enable: true, mode: "grab" },
                    onclick: { enable: true, mode: "push" }
                }
            }
        });

        /* --- Page 1: 生成3D圆环卡片 --- */
        const ring = document.getElementById('ring');
        const dataPoints = [
            "紫微斗数模型", "纳音五行算法", "易经六十四卦", 
            "大运流年推导", "真太阳时校正", "量化金融模型",
            "生命周期理论", "玄空飞星排盘", "天干地支刑冲", "贝叶斯概率修正"
        ];

        dataPoints.forEach((text, index) => {
            const card = document.createElement('div');
            card.className = 'card-3d';
            const angle = index * 36;
            card.style.transform = `rotateY(${angle}deg) translateZ(400px)`;
            card.innerHTML = `
                <div class="card-title">SOURCE ${index + 1}</div>
                <div style="font-size:1.4rem; font-weight:bold;">${text}</div>
                <div style="margin-top:auto; font-size:0.6rem; opacity:0.6;">VERIFIED DATA</div>
            `;
            ring.appendChild(card);
        });

        /* --- Page Switch Logic --- */
        function goToPage(n) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page${n}`).classList.add('active');
        }

        /* --- Page 2 Logic --- */
        let selectedData = { gender: '', year: null, month: null, day: null };
        let currentPicking = '';

        function selectGender(el, val) {
            document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            selectedData.gender = val;
        }

        function openGrid(type) {
            currentPicking = type;
            const overlay = document.getElementById('gridOverlay');
            const content = document.getElementById('gridContent');
            const title = document.getElementById('gridTitle');
            content.innerHTML = '';
            overlay.style.display = 'flex';

            let start, end;
            if (type === 'year') {
                title.innerText = "请选择出生年份";
                start = 1960; end = 2025;
            } else if (type === 'month') {
                title.innerText = "请选择出生月份";
                start = 1; end = 12;
            } else {
                title.innerText = "请选择出生日期";
                start = 1; end = 31;
            }

            for (let i = start; i <= end; i++) {
                const num = document.createElement('div');
                num.className = 'grid-num';
                num.innerText = i;
                num.onclick = () => pickNumber(i);
                content.appendChild(num);
            }
        }

        function pickNumber(num) {
            selectedData[currentPicking] = num;
            const box = document.getElementById(`${currentPicking}Box`);
            box.innerText = num + (currentPicking === 'year' ? '年' : (currentPicking === 'month' ? '月' : '日'));
            box.classList.add('filled');
            document.getElementById('gridOverlay').style.display = 'none';
        }

        function closeGrid(e) {
            if (e.target.id === 'gridOverlay') {
                e.target.style.display = 'none';
            }
        }

        /* --- Page 3 & Chart Logic --- */
        let globalChartData = null; // 存储当前生成的数据用于评价

        function generateChart() {
            const name = document.getElementById('nameInput').value;
            if (!name || !selectedData.year || !selectedData.month || !selectedData.day || !selectedData.gender) {
                alert("请完整填写命盘信息，方可推演。");
                return;
            }

            goToPage(3);
            document.getElementById('resName').innerText = name;
            document.getElementById('resInfo').innerText = `${selectedData.gender} | ${selectedData.year}年${selectedData.month}月${selectedData.day}日生 | 命主元神`;

            initKlineChart(name);
        }

        function initKlineChart(name) {
            const chartDom = document.getElementById('kline');
            const myChart = echarts.init(chartDom);
            
            const data = generateRealisticData();
            globalChartData = data; // 保存数据用于评价

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'line', lineStyle: { color: '#cba051', type: 'dashed' } },
                    backgroundColor: 'rgba(20,20,20,0.95)',
                    borderColor: '#cba051',
                    textStyle: { color: '#fff', fontSize: 14 },
                    /* 修改点：Tooltip 仅显示当前年龄 */
                    formatter: function (params) {
                        // params[0] 是第一个系列的数据，name 是 x轴的值（年龄）
                        return `<div style="padding:5px 10px; font-weight:bold; color:#cba051;">当前年龄：${params[0].name}</div>`;
                    }
                },
                grid: { left: '5%', right: '5%', top: '10%', bottom: '10%' },
                xAxis: {
                    type: 'category',
                    data: data.years,
                    axisLine: { lineStyle: { color: '#444' } },
                    axisLabel: { color: '#666' }
                },
                yAxis: {
                    scale: true,
                    splitLine: { lineStyle: { color: '#222' } },
                    axisLabel: { show: false }
                },
                series: [
                    {
                        name: '运势',
                        type: 'candlestick',
                        data: data.values,
                        itemStyle: {
                            color: '#cba051',
                            color0: '#5470c6',
                            borderColor: '#cba051',
                            borderColor0: '#5470c6'
                        },
                        markPoint: {
                            data: data.annotations,
                            symbol: 'pin',
                            symbolSize: 45,
                            itemStyle: { color: '#fff' },
                            label: { color: '#000', fontWeight: 'bold', fontSize: 10 }
                        }
                    },
                    {
                        name: '趋势',
                        type: 'line',
                        data: calculateMA(10, data.values),
                        smooth: true,
                        lineStyle: { opacity: 0.5, color: '#fff', width: 1 },
                        symbol: 'none'
                    }
                ]
            };

            option.graphic = data.texts.map(t => ({
                type: 'text',
                left: t.x,
                top: t.y,
                style: {
                    text: t.text,
                    fill: '#cba051',
                    font: '14px "Songti SC"'
                }
            }));

            myChart.setOption(option);
            window.addEventListener('resize', () => myChart.resize());
        }

        /* --- 评价逻辑 --- */
        function showEvaluation() {
            if (!globalChartData) return;
            generateAnalysis(globalChartData);
            document.getElementById('evalOverlay').style.display = 'flex';
        }

        function closeEval(e) {
            if (!e || e.target.id === 'evalOverlay') {
                document.getElementById('evalOverlay').style.display = 'none';
            }
        }

        function generateAnalysis(data) {
            // 解析数据
            // values数组元素: [open, close, low, high]
            const values = data.values;
            let maxRise = 0, maxRiseAge = 0;
            let maxFall = 0, maxFallAge = 0;
            let startPrice = parseFloat(values[0][0]);
            let endPrice = parseFloat(values[values.length - 1][1]);
            let maxPrice = 0, maxPriceAge = 0;

            // 寻找关键节点
            for (let i = 0; i < values.length; i++) {
                let open = parseFloat(values[i][0]);
                let close = parseFloat(values[i][1]);
                let high = parseFloat(values[i][3]);
                
                let change = close - open;
                if (change > maxRise) { maxRise = change; maxRiseAge = i; }
                if (change < maxFall) { maxFall = change; maxFallAge = i; }
                if (high > maxPrice) { maxPrice = high; maxPriceAge = i; }
            }

            // 生成评价词
            let summary = "";
            let detail = "";

            // 逻辑树
            if (endPrice > startPrice + 30) {
                summary = "青云直上，大器晚成";
            } else if (endPrice < startPrice - 20) {
                summary = "繁华落尽，归于平淡";
            } else if (maxRise > 10 && maxFall < -10) {
                summary = "跌宕起伏，波澜壮阔";
            } else {
                summary = "稳中求进，福寿安康";
            }

            // 生成具体解析
            detail = `纵观一生，运势${endPrice > startPrice ? '总体向上' : '起伏不定'}。`;
            
            if (maxRiseAge > 0) {
                detail += `机缘在${maxRiseAge}岁时显现，运势陡升。`;
            }
            
            if (maxFallAge > 0) {
                detail += `需留意${maxFallAge}岁时的坎坷，`;
                if (maxFallAge < maxRiseAge) {
                    detail += `好在渡劫之后必有后福。`;
                } else {
                    detail += `宜韬光养晦，守成即可。`;
                }
            }

            if (maxPriceAge > 80) {
                detail += ` 难得的是晚年运势极佳，福泽深厚啊！`;
            } else if (maxPriceAge < 30) {
                detail += ` 少年成名，锐气十足。`;
            }

            document.getElementById('evalSummary').innerText = `“${summary}”`;
            document.getElementById('evalDetail').innerText = `“${detail}”`;
        }

        function generateRealisticData() {
            let years = [];
            let values = [];
            let annotations = [];
            let texts = [];
            let price = 50;

            for (let i = 0; i <= 100; i++) {
                years.push(i + "岁");
                let change = (Math.random() - 0.45) * 8; 
                if (i > 22 && i < 30) change += 2; 
                if (i === 18) change = -5; 
                if (i === 60) change = 5;  

                let open = price;
                let close = price + change;
                let low = Math.min(open, close) - Math.random() * 3;
                let high = Math.max(open, close) + Math.random() * 3;

                if (low < 10) { low = 10; close = 12; open = 11; }

                values.push([open.toFixed(1), close.toFixed(1), low.toFixed(1), high.toFixed(1)]);
                
                if (change > 6) {
                    annotations.push({ name: '大运', coord: [i, high], value: '大吉' });
                    if (texts.length < 3) {
                        texts.push({ text: i+'岁：鸿运当头', x: (i) + '%', y: '20%' });
                    }
                }
                if (change < -5) {
                    annotations.push({ name: '磨砺', coord: [i, low], value: '渡劫', itemStyle:{color:'#5470c6'} });
                     if (texts.length < 3) {
                        texts.push({ text: i+'岁：韬光养晦', x: (i) + '%', y: '80%' });
                    }
                }

                price = close;
            }
            return { years, values, annotations, texts };
        }

        function calculateMA(dayCount, data) {
            var result = [];
            for (var i = 0, len = data.length; i < len; i++) {
                if (i < dayCount) { result.push('-'); continue; }
                var sum = 0;
                for (var j = 0; j < dayCount; j++) { sum += parseFloat(data[i - j][1]); }
                result.push((sum / dayCount).toFixed(1));
            }
            return result;
        }
    </script>
</body>
</html>